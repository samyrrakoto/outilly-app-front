<div *ngIf="loaded" class="columns is-centered">
  <div class="column is-6">
    <div class="content">
      <h2 class="subtitle">Mes ventes</h2>
      <div id="notifications"></div>

      <div class="content" *ngIf="sellerOrders.length === 0">
        Vous n'avez posté aucune annonce pour le moment :'-(

        <div class="content">
          <a routerLink="/product/create" class="button is-success">Commencer à vendre</a>
        </div>
      </div>

      <mat-accordion *ngIf="sellerOrders.length > 0">
        <mat-expansion-panel *ngFor="let order of sellerOrders">
            <mat-expansion-panel-header>
            <mat-panel-title>
              <div *ngIf="isRequiringAction(order)" class="content">
                <fa-icon class="notification-icon" [icon]="['fas', 'bell']"></fa-icon>
              </div>

              <div class="content product-title">
                {{ order.sale.product.name }}
              </div>

              <div class="content order-date has-text-right discreet-text">
                {{ order.createdAt | date:'dd-MM-yyyy'}}
              </div>
            </mat-panel-title>
            </mat-expansion-panel-header>
            <mat-panel-description>

            </mat-panel-description>
            <div *ngIf="isRequiringAction(order)" class="content warning has-text-centered">
              <fa-icon class="notification-icon" [icon]="['fas', 'exclamation-triangle']"></fa-icon>
              Vous avez une action à effectuer pour cette vente
            </div>

            <h2 class="subtitle announce has-text-centered">
              Félicitations ! Quelqu'un a acheté votre produit !
            </h2>

            <div class="columns">
              <div class="column left has-text-centered-mobile">
                <div class="content">
                  Prix : <span class="bold">{{ order.amountPrice | currency:'full' }}€</span>
                </div>

                <div class="content">
                  N° de commande : <span class="bold">{{ order.id }}</span>
                </div>
              </div>

              <div class="column has-text-centered-mobile">
                <div class="content">
                  Date de commande : <span *ngIf="order.transaction !== null" class="bold">{{ order.transaction.createdAt | date:'dd-MM-yyyy' }}</span>
                </div>
              </div>
            </div>

            <div class="is-divider"></div>

            <!-- MONDIAL RELAY DELIVERY -->

            <!-- If delivery note has been generated -->
            <div *ngIf="isRelayDelivery(order) && isDeliveryNoteGenerated(order)" class="content">
              <div class="content has-text-centered">
                <button *ngIf="!order.isSent" (click)="currentOrder = order; modals.open('send-order-confirmation')" class="button is-success no-overflow has-text-white">
                  <fa-icon [icon]="['fas', 'box']"></fa-icon>
                  Confirmer l'envoi du colis
                </button>

                <!-- If order sent -->
                <div *ngIf="order.isSent">
                  <article *ngIf="!order.isDelivered" class="message is-success">
                    <div class="message-body">
                      <fa-icon [icon]="['fas', 'check-square']"></fa-icon>
                      Envoi du colis confirmé, vous recevrez une confirmation de l'acheteur une fois reçu !
                    </div>
                  </article>

                  <article *ngIf="order.isDelivered" class="message is-success">
                    <div class="message-body">
                      <fa-icon [icon]="['fas', 'check-square']"></fa-icon>
                      L'acheteur a bien reçu votre colis !
                    </div>
                  </article>
                </div>
              </div>

              <div class="content has-text-centered">
                <button *ngIf="!order.isSent" (click)="generateDispatchNote(order)" class="button no-overflow has-text-success">
                  <fa-icon id="redo" [icon]="['fas', 'redo']"></fa-icon>
                  Générer à nouveau mon bon d'envoi
                </button>
              </div>
            </div>

            <!-- If delivery note has NOT been generated yet -->
            <div *ngIf="isRelayDelivery(order) && !isDeliveryNoteGenerated(order)" class="content">
              <div class="content">
                <h2 class="subtitle announce has-text-centered">
                  L'acheteur souhaite se faire livrer par<br>
                  {{ order.shipMethod | delivery }}
                </h2>
              </div>

              <div class="content has-text-centered">
                <button (click)="goToDispatch(order)" class="button is-success no-overflow has-text-white">
                  <fa-icon [icon]="['fas', 'box']"></fa-icon>
                  Générer mon étiquette d'expédition
                </button>
              </div>
            </div>

            <!-- HAND DELIVERY -->
            <div *ngIf="isHandDelivery(order)" class="content">
              <div class="content">
                <h2 class="subtitle announce has-text-centered">
                  L'acheteur souhaite se faire livrer par<br>
                  <span class="accepted">{{ order.shipMethod | delivery}}</span>
                </h2>
              </div>

              <div *ngIf="!order.isAvailabilityConfirmed" class="content has-text-centered">
                <button (click)="currentOrder = order; modals.open('order-availability-confirmation')" class="button is-success">Confirmer la disponibilité du produit à l'acheteur</button>
              </div>

              <div *ngIf="order.isAvailabilityConfirmed" class="content has-text-centered">
                <button (click)="currentBuyer = order.buyer.userProfile; modals.open('buyer-contact')" class="button is-success no-overflow has-text-white">
                  <fa-icon [icon]="['fas', 'phone-volume']"></fa-icon>
                  Contacter l'acheteur pour convenir d'un rendez-vous
                </button>
              </div>
            </div>
            <a class="product-page" (click)="goToProductPage(order.sale.productSlug, order.sale.id)">Accéder à la page du produit</a>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>
</div>

<!-- ##### MODALS ##### -->

<!-- Buyer information -->
<div *ngIf="currentBuyer" class="modal {{ modals.get('buyer-contact') }}">
  <div class="modal-background" (click)="modals.close('buyer-contact')"></div>
  <div class="modal-content">
    <div class="box">
      <h2 class="subtitle">Infos de l'acheteur</h2>

      <div id="buyer-contact" class="content">
        <div class="content">
          <div class="content has-text-left-tablet has-text-centered-mobile">
            <fa-icon [icon]="['fas', 'user']"></fa-icon>
            {{ currentBuyer.firstname }} {{ currentBuyer.lastname | slice:0:1 }}.
          </div>

          <div *ngIf="currentBuyer.phone1 !== ''" class="content has-text-left-tablet has-text-centered-mobile">
            <fa-icon [icon]="['fas', 'phone-alt']"></fa-icon>
            {{ currentBuyer.phone1 | phone }}
          </div>

          <div class="content has-text-left-tablet has-text-centered-mobile">
            <fa-icon [icon]="['fas', 'envelope']"></fa-icon>
            {{ currentBuyer.email }}
          </div>

          <div *ngIf="currentBuyer.zipcode !== ''" class="content has-text-left-tablet has-text-centered-mobile">
            <fa-icon [icon]="['fas', 'house-user']"></fa-icon>
            {{ currentBuyer.mainAddress.zipcode }} {{ currentBuyer.mainAddress.city }}
          </div>
        </div>
    </div>
  </div>
  </div>
  <button class="modal-close is-large" aria-label="close" (click)="modals.close('buyer-contact')"></button>
</div>

<!-- Etiquette download -->
<div class="modal {{ modals.get('etiquette-download') }}">
  <div class="modal-background" (click)="modals.close('etiquette-download')"></div>
  <div class="modal-content">
    <div class="box">
      <div class="buttons">
        <a [href]="dispatchNoteA4" class="button is-success is-small no-overflow" download>
          <fa-icon [icon]="['fas', 'download']"></fa-icon>
          Télécharger mon bon au format A4
        </a>
        <a [href]="dispatchNoteA5" class="button is-success is-small no-overflow" download>
          <fa-icon [icon]="['fas', 'download']"></fa-icon>
          Télécharger mon bon au format A5
        </a>
      </div>
    </div>
  </div>
  <button class="modal-close is-large is-danger" aria-label="close" (click)="modals.close('etiquette-download')"></button>
</div>

<!-- Order availability confirmation -->
<div class="modal {{ modals.get('order-availability-confirmation') }}">
  <div (click)="modals.close('order-availability-confirmation')" class="modal-background"></div>
  <div class="modal-content">
    <div class="box">
      <h1 class="title">
        Confirmez-vous que le produit est toujours disponible ?
      </h1>

      <div class="field is-grouped">
        <p class="control">
          <button class="button is-success" (click)="availableConfirmation(currentOrder); modals.close('order-availability-confirmation')">Oui</button>
        </p>
        <p class="control">
          <button (click)="modals.close('order-availability-confirmation')" class="button is-light">Non</button>
        </p>
      </div>
    </div>
  </div>
  <button class="modal-close is-large is-danger" aria-label="close" (click)="modals.close('order-availability-confirmation')"></button>
</div>

<!-- Order send confirmation -->
<div class="modal {{ modals.get('send-order-confirmation') }}">
  <div (click)="modals.close('send-order-confirmation')" class="modal-background"></div>
  <div class="modal-content">
    <div class="box">
      <h1 class="title">
        Confirmez-vous que le colis a bel et bien été envoyé ?
      </h1>

      <div class="field is-grouped">
        <p class="control">
          <button class="button is-success" (click)="sendOrder(currentOrder.id); modals.close('send-order-confirmation')">Oui</button>
        </p>
        <p class="control">
          <button (click)="modals.close('send-order-confirmation')" class="button is-light">Non</button>
        </p>
      </div>
    </div>
  </div>
  <button class="modal-close is-large is-danger" aria-label="close" (click)="modals.close('send-order-confirmation')"></button>
</div>
